<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Appium Orchestrator</title>
    <!-- CodeMirror CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css"
    />
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/ide.css" />
    <link rel="stylesheet" href="css/autocomplete.css" />
  </head>
  <body>
    <div id="auth-overlay">
      <div>
        <h2>Appium Orchestrator</h2>
        <p>Por favor, inicia sesiÃ³n para continuar.</p>
        <a href="/auth/google">Login with Google</a>
      </div>
    </div>

    <div class="header" id="main-header">
      <div class="header-queue-section">
        <div id="queue-status-header">
          Estado: 0 en ejecuciÃ³n / 0 en cola (LÃ­mite: 0)
        </div>
        <div class="header-indicators">
          <div
            id="uncommitted-changes-indicator"
            class="commit-status-indicator hidden"
          >
            <span class="warning-icon">ğŸ“</span>
            <span class="status-text">Archivos modificados sin commit</span>
            <button id="header-commit-btn" class="commit-btn">Commit</button>
          </div>
          <div
            id="pending-commits-indicator"
            class="commit-status-indicator hidden"
          >
            <span class="warning-icon">â¬†ï¸</span>
            <span class="status-text">Commits pendientes de push</span>
            <button id="header-push-btn" class="push-btn">Push</button>
          </div>
        </div>
      </div>
      <div id="auth-container">
        <div id="user-info" style="display: none">
          <div>
            <div id="user-name"></div>
            <div id="user-email"></div>
          </div>
          <img id="user-photo" src="/placeholder.svg" alt="User photo" />
          <a href="/auth/logout">Logout</a>
        </div>

        <!-- Theme Toggle -->
        <div class="theme-toggle-container">
          <button
            id="theme-toggle"
            class="theme-toggle-btn"
            title="Cambiar tema"
            aria-label="Cambiar tema"
          >
            <span class="theme-icon" aria-hidden="true">ğŸŒ</span>
            <span class="theme-text">Light</span>
          </button>
        </div>

        <!-- Help Button -->
        <div class="help-container">
          <button
            id="help-btn"
            class="help-btn"
            title="Ayuda - Autocompletado y Glosario"
            aria-label="Ayuda"
          >
            <span class="help-icon" aria-hidden="true">â“</span>
            <span class="help-text">Ayuda</span>
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="tabs">
        <div class="tabs-container">
          <button class="tab-btn active" data-tab="setup">Setup</button>
          <button class="tab-btn" data-tab="workers">Workers</button>
          <button class="tab-btn" data-tab="queue">Cola</button>
          <button class="tab-btn" data-tab="results">Resultados</button>
          <button class="tab-btn" data-tab="wiremock">Wiremock</button>
        </div>
        <button id="stop-all-btn" class="danger-btn">Parar Todo ğŸ›‘</button>
      </div>

      <!-- Setup Tab -->
      <div id="setup-view" class="tab-content active">
        <!-- Compact Toolbar -->
        <div class="ide-toolbar" id="ide-toolbar">
          <button
            class="toolbar-collapse-toggle"
            id="toolbar-collapse-btn"
            style="display: none"
          >
            â˜°
          </button>
          <!-- Environment Controls -->
          <div class="toolbar-section">
            <div class="toolbar-group">
              <label for="client-select">Cliente:</label>
              <select id="client-select" class="compact-select">
                <option value="nbch">nbch</option>
                <option value="bpn">bpn</option>
                <option value="bind">bind</option>
              </select>
            </div>
            <div class="toolbar-group">
              <label for="branch-select">Branch:</label>
              <div class="compact-input-with-button">
                <select id="branch-select" class="compact-select">
                  <option>Cargando...</option>
                </select>
                <button
                  id="refresh-features-btn"
                  class="compact-refresh-btn"
                  title="Refrescar Features"
                >
                  â†»
                </button>
              </div>
            </div>
            <div class="toolbar-group">
              <label for="apk-version-select">APK:</label>
              <div class="compact-input-with-button">
                <select id="apk-version-select" class="compact-select" disabled>
                  <option>N/A</option>
                </select>
                <button
                  id="refresh-apk-versions-btn"
                  class="compact-refresh-btn"
                  title="Refresh APK Versions"
                >
                  â†»
                </button>
              </div>
            </div>
            <div class="toolbar-group hidden" id="device-selector-container">
              <label for="device-select">Device:</label>
              <div class="compact-input-with-button">
                <select id="device-select" class="compact-select"></select>
                <button
                  id="refresh-devices-btn"
                  class="compact-refresh-btn"
                  title="Refresh Devices"
                >
                  â†»
                </button>
              </div>
            </div>
          </div>

          <div class="toolbar-section">
            <div class="toolbar-group">
              <div class="toggle-matrix">
                <!-- Fila 1 -->
                <label class="toggle-label left" for="batch-priority-checkbox"
                  >âš¡ Prioridad</label
                >
                <input
                  class="toggle-chk"
                  type="checkbox"
                  id="batch-priority-checkbox"
                />
                <input
                  class="toggle-chk"
                  type="checkbox"
                  id="record-mappings-checkbox"
                />
                <label class="toggle-label right" for="record-mappings-checkbox"
                  >ğŸ”´ Record Mapping</label
                >

                <!-- Fila 2 -->
                <label
                  class="toggle-label left"
                  for="use-local-mappings-checkbox"
                  >ğŸ’¾ Use Mappings</label
                >
                <input
                  class="toggle-chk"
                  type="checkbox"
                  id="use-local-mappings-checkbox"
                />
                <input
                  class="toggle-chk"
                  type="checkbox"
                  id="persistent-workspace-checkbox"
                />
                <label
                  class="toggle-label right"
                  for="persistent-workspace-checkbox"
                  >ğŸ”„ Persistent Workspace</label
                >
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="toolbar-section">
            <button
              id="prepare-workspace-btn"
              class="compact-btn hidden"
              title="Preparar Workspace"
            >
              âš™ï¸
            </button>
            <button
              id="refresh-git-status-btn"
              class="compact-btn hidden"
              title="Refrescar Cambios (Git)"
            >
              ğŸ”„
            </button>
          </div>
        </div>

        <!-- IDE Container with Integrated Controls -->
        <div class="ide-main-container">
          <!-- IDE Header with Search and Execution -->
          <div class="ide-header">
            <div class="ide-search-section">
              <div class="search-group">
                <input
                  type="text"
                  id="features-filter"
                  placeholder="Buscar features..."
                  class="compact-search-input"
                />
                <select
                  id="feature-filter-select"
                  class="compact-filter-select"
                >
                  <option value="all">Todos</option>
                  <option value="modified">Modificados</option>
                </select>
              </div>
            </div>
            <div class="ide-execution-section">
              <div class="execution-controls">
                <label class="compact-checkbox-label">
                  <input type="checkbox" id="select-all-features" />
                  <span>Seleccionar Todo</span>
                </label>
                <button
                  id="run-selected-btn"
                  class="compact-btn execute-btn"
                  disabled
                >
                  â–· Ejecutar (0)
                </button>
              </div>
            </div>
          </div>

          <!-- IDE Container -->
          <div id="ide-container">
            <div id="feature-tree-panel">
              <div class="tree-controls">
                <button
                  id="new-test-btn"
                  class="new-test-btn"
                  style="display: none"
                  title="Crear nuevo test en la ubicaciÃ³n actual"
                >
                  â• Nuevo Test
                </button>
              </div>
              <ul id="features-list">
                <li>Selecciona cliente y branch para buscar features.</li>
              </ul>
            </div>
            <div id="editor-panel"></div>
          </div>
        </div>
      </div>

      <!-- Workers Tab -->
      <div id="workers-view" class="tab-content">
        <h2>Estado de Workers</h2>
        <div id="worker-status-container"></div>
        <div id="log-panels-container" class="panels-container">
          <div id="log-panel-system" class="log-panel">
            <div class="panel-header status-initializing">
              Worker 0 (Sistema)
            </div>
            <div class="panel-content">
              Logs de operaciones del sistema aparecerÃ¡n aquÃ­...
            </div>
          </div>
        </div>
      </div>

      <!-- Queue Tab -->
      <div id="queue-view" class="tab-content">
        <h2>Cola de Espera</h2>
        <ul
          id="queued-tests-list"
          style="
            list-style-type: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            background: white;
            box-shadow: var(--shadow-sm);
          "
        ></ul>
      </div>

      <!-- Results Tab -->
      <div id="results-view" class="tab-content">
        <h2>Resultados Recientes</h2>
        <div class="controls">
          <label for="history-branch-filter">Filtrar por Branch:</label>
          <select id="history-branch-filter">
            <option value="">Todas</option>
          </select>
        </div>
        <ul
          id="history-list"
          style="
            list-style-type: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            background: white;
            box-shadow: var(--shadow-sm);
          "
        ></ul>
      </div>

      <!-- Wiremock Tab -->
      <div id="wiremock-view" class="tab-content">
        <div class="sub-tabs">
          <button class="sub-tab-btn active" data-subtab="main">Main</button>
          <button class="sub-tab-btn" data-subtab="requests">
            Requests Log
          </button>
        </div>

        <div id="wiremock-main-view" class="sub-tab-content active">
          <h2>Wiremock Control</h2>
          <div class="controls">
            <button id="wiremock-list-mappings-btn">List Mappings</button>
            <button
              id="wiremock-delete-mappings-btn"
              style="
                background-color: var(--danger-color);
                border-color: var(--danger-color);
              "
            >
              Delete All Mappings
            </button>
            <button
              id="wiremock-reset-mappings-btn"
              style="
                background-color: var(--warning-color);
                border-color: var(--warning-color);
                color: white;
              "
            >
              Reset Mappings
            </button>
            <button
              id="wiremock-base-mappings-btn"
              style="
                background-color: var(--info-color);
                border-color: var(--info-color);
              "
            >
              Base Mappings
            </button>
            <button
              id="open-mappings-download-modal-btn"
              style="
                background-color: var(--primary-color);
                border-color: var(--primary-color);
              "
            >
              Download Mappings...
            </button>
          </div>
          <pre
            id="wiremock-mappings-output"
          ></pre>
          <hr style="margin: 2em 0" />
          <h3>Import Mappings</h3>
          <div class="controls">
            <textarea
              id="wiremock-import-textarea"
              rows="10"
              style="
                width: 100%;
                font-family:
                  'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas,
                  'Courier New', monospace;
              "
            ></textarea>
          </div>
          <div class="controls">
            <button id="wiremock-import-mappings-btn">
              Import Mappings from Text
            </button>
            <button
              id="wiremock-upload-mappings-btn"
              style="
                background-color: var(--gray-500);
                border-color: var(--gray-500);
              "
            >
              Upload JSON File
            </button>
            <input
              type="file"
              id="wiremock-upload-input"
              style="display: none"
              accept=".json"
            />
          </div>
          <hr style="margin: 2em 0" />
          <h3>Recording</h3>
          <div class="controls">
            <label for="wiremock-recording-name">Recording Name:</label>
            <input
              type="text"
              id="wiremock-recording-name"
              style="flex-grow: 1"
              placeholder="e.g., my-feature-mocks"
            />
          </div>
          <div class="controls">
            <label>
              <input type="checkbox" id="wiremock-save-as-single-file" />
              Save as single file
            </label>
          </div>
          <button id="wiremock-start-recording-btn">Start Recording</button>
          <button id="wiremock-stop-recording-btn">Stop Recording</button>
          <button id="wiremock-status-recording-btn">Get Status</button>
          <pre
            id="wiremock-recording-output"
            style="
              background: var(--gray-900);
              color: var(--gray-100);
              padding: 1.5rem;
              border-radius: 12px;
              max-height: 500px;
              overflow-y: auto;
              border: 1px solid var(--gray-200);
              box-shadow: var(--shadow-sm);
            "
          ></pre>
        </div>

        <div id="wiremock-requests-view" class="sub-tab-content">
          <h3>Received Requests</h3>
          <div class="controls">
            <button id="wiremock-list-requests-btn">List Requests</button>
            <button
              id="wiremock-delete-requests-btn"
              style="
                background-color: var(--danger-color);
                border-color: var(--danger-color);
              "
            >
              Delete All Requests
            </button>
            <label style="margin-left: auto">
              <input type="checkbox" id="wiremock-live-view-toggle" checked />
              Live View
            </label>
          </div>
          <div
            id="wiremock-requests-output"
          ></div>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/gherkin/gherkin.min.js"></script>
    <!-- Split.js for resizable panels -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/split.js/1.6.5/split.min.js"></script>
    <!-- Core Services -->
    <script type="module" src="js/core/service-registry.js"></script>
    <script type="module" src="js/core/global-services.js"></script>
    <!-- Theme Manager -->
    <script type="module" src="js/theme-manager.js"></script>
    <!-- Glosario Service -->
    <script type="module" src="js/glosario-service.js"></script>
    <!-- Glosario Insert Controller -->
    <script type="module" src="js/glosario-insert-controller.js"></script>
    <!-- Smart Actions Module -->
    <script type="module" src="js/smart-actions-loader.js"></script>
    <!-- Autocomplete Module -->
    <script
      type="module"
      src="js/autocomplete/autocomplete-service.js"
    ></script>
    <!-- Glosario UI -->
    <script type="module" src="js/glosario-ui.js"></script>
    <!-- Help Modal Service -->
    <script type="module" src="js/help-modal-service.js"></script>
    <!-- Main Application -->
    <script type="module" src="js/main.js"></script>

    <!-- Legacy Compatibility (to be removed) -->
    <script type="module">
      import { createLegacyAliases } from './js/core/service-registry.js';
      createLegacyAliases();
    </script>

    <!-- Mappings Download Modal -->
    <div id="mappings-download-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Descargar Mappings</h2>
          <span class="close-btn">&times;</span>
        </div>
        <div>
          <label>
            <input type="checkbox" id="mappings-select-all" />
            Seleccionar Todo
          </label>
        </div>
        <div
          id="mappings-list-container"
          style="
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            background: var(--gray-50);
          "
        >
          <p>Cargando...</p>
        </div>
        <button
          id="download-selected-mappings-btn"
          style="
            width: 100%;
            padding: 0.8em;
            margin-top: 1em;
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            transition: all 0.2s ease;
          "
        >
          Descargar SelecciÃ³n
        </button>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal">
      <div class="modal-content help-modal-content">
        <div class="modal-header">
          <h2>ğŸš€ Ayuda: Autocompletado y Glosario</h2>
          <span class="close-btn" id="help-modal-close">&times;</span>
        </div>
        <div class="modal-body help-modal-body">
          <!-- SecciÃ³n: Autocompletado -->
          <div class="help-section">
            <h3 class="help-section-title">ğŸ¯ Autocompletado Inteligente</h3>
            <div class="help-content">
              <p>
                El editor cuenta con un sistema de autocompletado inteligente
                que te ayuda a escribir steps de Gherkin mÃ¡s rÃ¡pido.
              </p>

              <div class="help-feature">
                <h4>ğŸ“ <strong>Modo Persistente (Nuevo)</strong></h4>
                <div class="help-code">
                  <kbd>Ctrl+Space</kbd> - Activar autocompletado persistente
                </div>
                <ul class="help-features-list">
                  <li>El widget se mantiene visible mientras escribes</li>
                  <li>Las sugerencias se actualizan en tiempo real</li>
                  <li>Usa las flechas para navegar</li>
                  <li>
                    Presiona <kbd>Enter</kbd> o <kbd>Tab</kbd> para seleccionar
                  </li>
                  <li>Presiona <kbd>Escape</kbd> para cerrar</li>
                </ul>
              </div>

              <div class="help-feature">
                <h4>ğŸ”„ <strong>Auto-triggers</strong></h4>
                <p>El autocompletado se activa automÃ¡ticamente cuando:</p>
                <ul class="help-features-list">
                  <li>Escribes <code>Given </code> (con espacio)</li>
                  <li>Escribes <code>When </code> (con espacio)</li>
                  <li>Escribes <code>Then </code> (con espacio)</li>
                  <li>Escribes <code>{</code> para referencias JSON</li>
                  <li>EstÃ¡s en una lÃ­nea vacÃ­a despuÃ©s de un Scenario</li>
                </ul>
              </div>

              <div class="help-feature">
                <h4>ğŸ¨ <strong>Tipos de Sugerencias</strong></h4>
                <div class="help-types-grid">
                  <div class="help-type">
                    <span class="help-type-icon">ğŸ“</span>
                    <strong>Steps</strong>
                    <span class="help-type-desc">Steps del glosario</span>
                  </div>
                  <div class="help-type">
                    <span class="help-type-icon">ğŸ”—</span>
                    <strong>JSON</strong>
                    <span class="help-type-desc">Referencias JSON</span>
                  </div>
                  <div class="help-type">
                    <span class="help-type-icon">ğŸ·ï¸</span>
                    <strong>Keywords</strong>
                    <span class="help-type-desc">Given/When/Then</span>
                  </div>
                  <div class="help-type">
                    <span class="help-type-icon">ğŸ’¡</span>
                    <strong>Contextuales</strong>
                    <span class="help-type-desc">Sugerencias inteligentes</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- SecciÃ³n: Glosario -->
          <div class="help-section">
            <h3 class="help-section-title">ğŸ“š Glosario de Steps</h3>
            <div class="help-content">
              <p>
                El glosario es una colecciÃ³n de steps predefinidos que puedes
                reutilizar en tus archivos de feature.
              </p>

              <div class="help-feature">
                <h4>ğŸ” <strong>Acceso al Glosario</strong></h4>
                <p>Puedes acceder al glosario de varias formas:</p>
                <ul class="help-features-list">
                  <li>
                    <strong>Panel del glosario</strong> - PestaÃ±a "Glosario" en
                    el sidebar
                  </li>
                  <li>
                    <strong>Click derecho</strong> - En el editor para ver steps
                    disponibles
                  </li>
                  <li>
                    <strong>Autocompletado</strong> - Los steps aparecen en las
                    sugerencias
                  </li>
                  <li>
                    <strong>Smart Actions</strong> - Actions inteligentes en el
                    editor
                  </li>
                </ul>
              </div>

              <div class="help-feature">
                <h4>ğŸ¯ <strong>Uso de Variables</strong></h4>
                <p>
                  Los steps pueden contener variables que se reemplazan al
                  usarlos:
                </p>
                <div class="help-example">
                  <pre><code># Step en el glosario:
"Given the user is on {page}"

# Se convierte en:
"Given the user is on login page"
"Given the user is on home page"</code></pre>
                </div>
              </div>
            </div>
          </div>

          <!-- SecciÃ³n: Tips y Trucos -->
          <div class="help-section">
            <h3 class="help-section-title">ğŸ’¡ Tips y Trucos</h3>
            <div class="help-content">
              <div class="help-feature">
                <h4>ğŸ¨ <strong>Smart Actions</strong></h4>
                <p>Actions inteligentes disponibles en el editor:</p>
                <ul class="help-features-list">
                  <li>
                    <strong>Insertar Step</strong> - Inserta un step del
                    glosario
                  </li>
                  <li>
                    <strong>Copiar Step</strong> - Copia un step al portapapeles
                  </li>
                  <li>
                    <strong>Referencias JSON</strong> - Gestiona variables y
                    datos
                  </li>
                  <li>
                    <strong>Formato AutomÃ¡tico</strong> - Indenta y formatea el
                    cÃ³digo
                  </li>
                </ul>
              </div>

              <div class="help-feature">
                <h4>ğŸ”„ <strong>ActualizaciÃ³n en Tiempo Real</strong></h4>
                <p>
                  El modo persistente actualiza las sugerencias mientras
                  escribes:
                </p>
                <ul class="help-features-list">
                  <li>Escribe "Given" â†’ Filtra steps que contienen "Given"</li>
                  <li>Escribe "user" â†’ Filtra steps que contienen "user"</li>
                  <li>Las sugerencias se actualizan en ~100ms</li>
                  <li>El texto coincidente se resalta</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- SecciÃ³n: Ejemplos -->
          <div class="help-section">
            <h3 class="help-section-title">ğŸ“ Ejemplos PrÃ¡cticos</h3>
            <div class="help-content">
              <div class="help-example">
                <h4>ğŸ¯ <strong>Ejemplo 1: Flujo Completo</strong></h4>
                <ol class="help-example-steps">
                  <li>
                    Presiona <kbd>Ctrl+Space</kbd> â†’ Se abre el widget
                    persistente
                  </li>
                  <li>
                    El widget muestra "MODO PERSISTENTE - Sigue escribiendo..."
                  </li>
                  <li>
                    Escribe "Given" â†’ Las sugerencias se filtran automÃ¡ticamente
                  </li>
                  <li>
                    Usa <kbd>â†“</kbd> para seleccionar "Given the user is on
                    login page"
                  </li>
                  <li>
                    Presiona <kbd>Enter</kbd> â†’ El step se inserta con
                    indentaciÃ³n
                  </li>
                  <li>El widget se cierra automÃ¡ticamente</li>
                </ol>
              </div>

              <div class="help-example">
                <h4>ğŸ¨ <strong>Ejemplo 2: Referencias JSON</strong></h4>
                <pre><code>Scenario: Login with test data
  Given the user is on login page
  When the user enters credentials {"username":"test", "password":"123"}
  Then the user should be redirected to home page</code></pre>
                <p class="help-example-note">
                  Las referencias JSON aparecen al escribir <code>{</code>
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer help-modal-footer">
          <button id="help-got-it-btn" class="btn-primary">Â¡Entendido!</button>
        </div>
      </div>
    </div>
  </body>
</html>
