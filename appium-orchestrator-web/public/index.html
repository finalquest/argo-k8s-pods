<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Appium Orchestrator</title>
    <!-- CodeMirror CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css"
    />
    <link rel="stylesheet" href="css/styles.css">
  </head>
  <body>
    <div id="auth-overlay">
      <div>
        <h2>Appium Orchestrator</h2>
        <p>Por favor, inicia sesi√≥n para continuar.</p>
        <a href="/auth/google">Login with Google</a>
      </div>
    </div>

    <div class="header">
      <h1>Appium Orchestrator Web</h1>
      <div id="queue-status"></div>
      <div id="auth-container">
        <div id="user-info" style="display: none">
          <div>
            <div id="user-name"></div>
            <div id="user-email"></div>
          </div>
          <img
            id="user-photo"
            src="/placeholder.svg"
            alt="User photo"
          />
          <a href="/auth/logout">Logout</a>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="tabs">
        <div class="tabs-container">
          <button class="tab-btn active" data-tab="setup">Setup</button>
          <button class="tab-btn" data-tab="workers">Workers</button>
          <button class="tab-btn" data-tab="queue">Cola</button>
          <button class="tab-btn" data-tab="results">Resultados</button>
          <button class="tab-btn" data-tab="wiremock">Wiremock</button>
        </div>
        <button id="stop-all-btn" class="danger-btn">
          Parar Todo üõë
        </button>
      </div>

      <!-- Setup Tab -->
      <div id="setup-view" class="tab-content active">
        <!-- Environment Configuration Card -->
        <div class="config-card">
          <div class="card-header">
            <h3>‚öôÔ∏è Configuraci√≥n del Entorno</h3>
            <div class="header-actions">
              <button id="prepare-workspace-btn" class="secondary-btn hidden">
                ‚öôÔ∏è Preparar Workspace
              </button>
              <button id="refresh-git-status-btn" class="secondary-btn hidden">
                üîÑ Refrescar Cambios (Git)
              </button>
            </div>
          </div>
          <div class="card-content">
            <div class="config-grid">
              <div class="config-item">
                <label for="client-select">Cliente:</label>
                <select id="client-select">
                  <option value="nbch">nbch</option>
                  <option value="bpn">bpn</option>
                  <option value="bind">bind</option>
                </select>
              </div>
              <div class="config-item">
                <label for="branch-select">Branch:</label>
                <select id="branch-select">
                  <option>Cargando...</option>
                </select>
              </div>
              <div class="config-item">
                <label for="apk-version-select">Versi√≥n APK:</label>
                <div class="input-with-button">
                  <select id="apk-version-select" disabled>
                    <option>N/A</option>
                  </select>
                  <button
                    id="refresh-apk-versions-btn"
                    class="refresh-btn"
                    title="Refresh APK Versions"
                  >
                    &#x21bb;
                  </button>
                </div>
              </div>
              <div class="config-item" id="device-selector-container" class="hidden">
                <label for="device-select">Device:</label>
                <div class="input-with-button">
                  <select id="device-select"></select>
                  <button
                    id="refresh-devices-btn"
                    class="refresh-btn"
                    title="Refresh Devices"
                  >
                    &#x21bb;
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Execution Options Card -->
        <div class="config-card">
          <div class="card-header">
            <h3>‚öôÔ∏è Opciones de Ejecuci√≥n</h3>
          </div>
          <div class="card-content">
            <div class="options-grid">
              <label class="checkbox-label">
                <input type="checkbox" id="batch-priority-checkbox" />
                Alta Prioridad ‚ö°
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="record-mappings-checkbox" />
                Grabar Mappings üî¥
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="use-local-mappings-checkbox" />
                Usar Mappings Locales üíæ
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="persistent-workspace-checkbox" />
                Workspace Persistente üîÑ
              </label>
            </div>
          </div>
        </div>


        <!-- Search and Execution Card -->
        <div class="config-card">
          <div class="card-header">
            <h3>‚öôÔ∏è B√∫squeda y Ejecuci√≥n</h3>
            <button id="fetch-features-btn" class="secondary-btn">
              üîç Buscar Features
            </button>
          </div>
          <div class="card-content">
            
            <div class="search-controls">
              <div class="search-input-group">
                <label for="features-filter">Buscar:</label>
                <input 
                  type="text" 
                  id="features-filter" 
                  placeholder="Filtrar por feature completa..."
                  class="features-filter-input"
                />
              </div>
              <div class="status-filter-group">
                <label for="feature-filter-select">Estado:</label>
                <select id="feature-filter-select">
                  <option value="all">Todos</option>
                  <option value="modified">Solo Modificados</option>
                </select>
              </div>
            </div>

            <div class="execution-controls">
              <div class="selection-controls">
                <label class="checkbox-label">
                  <input type="checkbox" id="select-all-features" />
                  Seleccionar Todo
                </label>
                <button id="commit-changes-btn" class="commit-btn hidden">
                  ‚Üê Hacer Commit de Cambios
                </button>
              </div>
              <button id="run-selected-btn" class="execute-btn" disabled>
                ‚ñ∑ Ejecutar Selecci√≥n (0)
              </button>
            </div>

            <ul id="features-list">
              <li>Selecciona cliente y branch para buscar features.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Workers Tab -->
      <div id="workers-view" class="tab-content">
        <h2>Estado de Workers</h2>
        <div id="worker-status-container"></div>
        <div id="log-panels-container" class="panels-container">
          <div id="log-panel-system" class="log-panel">
            <div class="panel-header status-initializing">
              Worker 0 (Sistema)
            </div>
            <div class="panel-content">
              Logs de operaciones del sistema aparecer√°n aqu√≠...
            </div>
          </div>
        </div>
      </div>

      <!-- Queue Tab -->
      <div id="queue-view" class="tab-content">
        <h2>Cola de Espera</h2>
        <ul
          id="queued-tests-list"
          style="
            list-style-type: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            background: white;
            box-shadow: var(--shadow-sm);
          "
        ></ul>
      </div>

      <!-- Results Tab -->
      <div id="results-view" class="tab-content">
        <h2>Resultados Recientes</h2>
        <div class="controls">
          <label for="history-branch-filter">Filtrar por Branch:</label>
          <select id="history-branch-filter">
            <option value="">Todas</option>
          </select>
        </div>
        <ul
          id="history-list"
          style="
            list-style-type: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            background: white;
            box-shadow: var(--shadow-sm);
          "
        ></ul>
      </div>

      <!-- Wiremock Tab -->
      <div id="wiremock-view" class="tab-content">
        <div class="sub-tabs">
          <button class="sub-tab-btn active" data-subtab="main">Main</button>
          <button class="sub-tab-btn" data-subtab="requests">
            Requests Log
          </button>
        </div>

        <div id="wiremock-main-view" class="sub-tab-content active">
          <h2>Wiremock Control</h2>
          <div class="controls">
            <button id="wiremock-list-mappings-btn">List Mappings</button>
            <button
              id="wiremock-delete-mappings-btn"
              style="
                background-color: var(--danger-color);
                border-color: var(--danger-color);
              "
            >
              Delete All Mappings
            </button>
            <button
              id="wiremock-reset-mappings-btn"
              style="
                background-color: var(--warning-color);
                border-color: var(--warning-color);
                color: white;
              "
            >
              Reset Mappings
            </button>
            <button
              id="wiremock-base-mappings-btn"
              style="
                background-color: var(--info-color);
                border-color: var(--info-color);
              "
            >
              Base Mappings
            </button>
            <button
              id="open-mappings-download-modal-btn"
              style="
                background-color: var(--primary-color);
                border-color: var(--primary-color);
              "
            >
              Download Mappings...
            </button>
          </div>
          <pre
            id="wiremock-mappings-output"
            style="
              background: var(--gray-900);
              color: var(--gray-100);
              padding: 1.5rem;
              border-radius: 12px;
              max-height: 500px;
              overflow-y: auto;
              border: 1px solid var(--gray-200);
              box-shadow: var(--shadow-sm);
            "
          ></pre>
          <hr style="margin: 2em 0" />
          <h3>Import Mappings</h3>
          <div class="controls">
            <textarea
              id="wiremock-import-textarea"
              rows="10"
              style="
                width: 100%;
                font-family:
                  'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas,
                  'Courier New', monospace;
              "
            ></textarea>
          </div>
          <div class="controls">
            <button id="wiremock-import-mappings-btn">
              Import Mappings from Text
            </button>
            <button
              id="wiremock-upload-mappings-btn"
              style="
                background-color: var(--gray-500);
                border-color: var(--gray-500);
              "
            >
              Upload JSON File
            </button>
            <input
              type="file"
              id="wiremock-upload-input"
              style="display: none"
              accept=".json"
            />
          </div>
          <hr style="margin: 2em 0" />
          <h3>Recording</h3>
          <div class="controls">
            <label for="wiremock-recording-name">Recording Name:</label>
            <input
              type="text"
              id="wiremock-recording-name"
              style="flex-grow: 1"
              placeholder="e.g., my-feature-mocks"
            />
          </div>
          <div class="controls">
            <label>
              <input type="checkbox" id="wiremock-save-as-single-file" />
              Save as single file
            </label>
          </div>
          <button id="wiremock-start-recording-btn">Start Recording</button>
          <button id="wiremock-stop-recording-btn">Stop Recording</button>
          <button id="wiremock-status-recording-btn">Get Status</button>
          <pre
            id="wiremock-recording-output"
            style="
              background: var(--gray-900);
              color: var(--gray-100);
              padding: 1.5rem;
              border-radius: 12px;
              max-height: 500px;
              overflow-y: auto;
              border: 1px solid var(--gray-200);
              box-shadow: var(--shadow-sm);
            "
          ></pre>
        </div>

        <div id="wiremock-requests-view" class="sub-tab-content">
          <h3>Received Requests</h3>
          <div class="controls">
            <button id="wiremock-list-requests-btn">List Requests</button>
            <button
              id="wiremock-delete-requests-btn"
              style="
                background-color: var(--danger-color);
                border-color: var(--danger-color);
              "
            >
              Delete All Requests
            </button>
            <label style="margin-left: auto">
              <input type="checkbox" id="wiremock-live-view-toggle" checked />
              Live View
            </label>
          </div>
          <div
            id="wiremock-requests-output"
            style="
              background: var(--gray-900);
              color: var(--gray-100);
              padding: 1.5rem;
              border-radius: 12px;
              max-height: 70vh;
              overflow-y: auto;
              font-family:
                'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas,
                'Courier New', monospace;
              border: 1px solid var(--gray-200);
              box-shadow: var(--shadow-sm);
            "
          ></div>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/gherkin/gherkin.min.js"></script>
    <script type="module" src="js/main.js"></script>

    <!-- Mappings Download Modal -->
    <div id="mappings-download-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Descargar Mappings</h2>
          <span class="close-btn">&times;</span>
        </div>
        <div>
          <label>
            <input type="checkbox" id="mappings-select-all" />
            Seleccionar Todo
          </label>
        </div>
        <div
          id="mappings-list-container"
          style="
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            background: var(--gray-50);
          "
        >
          <p>Cargando...</p>
        </div>
        <button
          id="download-selected-mappings-btn"
          style="
            width: 100%;
            padding: 0.8em;
            margin-top: 1em;
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            transition: all 0.2s ease;
          "
        >
          Descargar Selecci√≥n
        </button>
      </div>
    </div>
  </body>
</html>
