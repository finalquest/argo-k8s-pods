apiVersion: apps/v1
kind: Deployment
metadata:
  name: books-bot
  namespace: media
  labels:
    app: books-bot
spec:
  replicas: 1
  selector:
    matchLabels:
      app: books-bot
  template:
    metadata:
      labels:
        app: books-bot
    spec:
      nodeSelector:
        media-node: "true"
      initContainers:
        - name: init-whitelist
          image: alpine:3.19
          command: ["sh", "-lc"]
          args:
            - |
              set -e

              echo "Checking whitelist file..."

              if [ ! -f /data/bot-whitelist.json ]; then
                echo "Creating bot-whitelist.json from secret ALLOWED_USER_IDS..."
                echo "{\"whitelist\": [\"$ALLOWED_USER_IDS\"], \"admin\": \"$ADMIN_USER_ID\"}" > /data/bot-whitelist.json
                echo "Whitelist file created successfully"
              else
                echo "bot-whitelist.json already exists, skipping"
              fi
          env:
            - name: ALLOWED_USER_IDS
              valueFrom:
                secretKeyRef:
                  name: books-bot-secrets
                  key: ALLOWED_USER_IDS
            - name: ADMIN_USER_ID
              valueFrom:
                secretKeyRef:
                  name: books-bot-secrets
                  key: ADMIN_USER_ID
          volumeMounts:
            - name: biblioteca-data
              mountPath: /data
      containers:
        - name: books-bot
          image: harbor.finalq.xyz/tools/books-bot:v3.0.1
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
          envFrom:
            - configMapRef:
                name: books-bot-config
            - secretRef:
                name: books-bot-secrets
            - secretRef:
                name: books-bot-smtp
            - secretRef:
                name: books-bot-lazy
          env:
            - name: ADMIN_USER_ID
              valueFrom:
                secretKeyRef:
                  name: books-bot-secrets
                  key: ADMIN_USER_ID
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 1
              memory: 1Gi
          volumeMounts:
            - name: biblioteca-data
              mountPath: /data
      volumes:
        - name: biblioteca-data
          persistentVolumeClaim:
            claimName: biblioteca-secreta-nfs
